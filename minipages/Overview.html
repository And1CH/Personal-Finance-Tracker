<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Общ преглед</title>
  <!-- FontAwesome & Chart.js -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* --------------------------------
       GLOBAL BASE STYLES
    -------------------------------- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      width: 100%;
      height: 100%;
      font-family: Arial, sans-serif;
      background-color: #f8f9fb; /* Very slightly cooler background */
      color: #4a4a4a;
      display: flex;
      overflow: hidden;
    }
    
    /* --------------------------------
       SIDEBAR
    -------------------------------- */
    .sidebar {
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      width: 60px; /* Collapsed width */
      background-color: #f2f4f7;   
      border-right: 1px solid #d5d8dd;
      overflow: hidden;
      transition: width 0.3s ease;
      z-index: 1000;
    }
    .sidebar:hover {
      width: 200px; /* Expanded width */
    }
    .sidebar .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 15px;
      color: #6c4f3d;
      font-size: 18px;
      font-weight: bold;
      white-space: nowrap;
      transition: padding 0.3s ease;
    }
    .sidebar:hover .logo {
      justify-content: flex-start;
      padding-left: 15px;
    }
    .sidebar .logo i {
      margin-right: 10px;
      margin-left: 6px;
    }
    .sidebar .logo span {
      display: none;
    }
    .sidebar:hover .logo span {
      display: inline-block;
    }
    .menu {
      list-style: none;
      padding: 0;
      margin-top: 20px;
    }
    .menu li {
      margin-bottom: 15px;
      text-align: center;
    }
    .menu li a {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      color: #5e5450; /* Less warm */
      text-decoration: none;
      font-size: 16px;
      padding: 10px;
      border-radius: 5px;
      transition: background-color 0.3s ease, color 0.3s ease;
      white-space: nowrap;
      overflow: hidden;
    }
    .sidebar:hover .menu li a {
      justify-content: flex-start;
      padding-left: 20px;
    }
    .menu li a i {
      font-size: 18px;
    }
    .menu li a span {
      display: none;
    }
    .sidebar:hover .menu li a span {
      display: inline-block;
    }
    .menu li a:hover {
      background-color: #a27e6c;
      color: #fff;
    }
    .menu li a.active i {
      color: #b58969;
    }
    .sidebar:hover ~ .main-content {
      margin-left: 200px;
      width: calc(100% - 200px);
    }
    
    /* --------------------------------
       MAIN CONTENT
    -------------------------------- */
    .main-content {
      margin-left: 60px;
      width: calc(100% - 60px);
      height: 100%;
      overflow-y: auto;
      padding: 20px;
      transition: margin-left 0.3s ease, width 0.3s ease;
      position: relative;
    }
    
    /* --------------------------------
       HEADER
    -------------------------------- */
    header {
      text-align: center;
      margin-bottom: 30px;
    }
    header h1 {
      font-size: 32px;
      font-weight: bold;
      color: #6c4f3d;
      margin-bottom: 5px;
    }
    header p {
      font-size: 16px;
      color: #555;
    }
    
    /* Removed .balance-info block entirely 
       since it was crossed out in the picture. */
    
    /* Budgets container (card) is now bigger & spaced out */
    #budget-message-box {
      max-width: 600px;
      margin: 30px auto; /* Center it and add spacing */
      background-color: #fff;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.07);
      transition: transform 0.2s;
    }
    #budget-message-box:hover {
      transform: scale(1.02);
    }
    #budget-message-box h3 {
      margin-bottom: 10px;
      font-size: 18px;
      color: #6c4f3d;
      text-align: center;
    }
    #budget-message {
      text-align: center;
      font-size: 16px;
      font-weight: bold;
      color: #b58969;
      opacity: 0; /* initially hidden */
      transition: opacity 0.5s ease-in-out;
    }
    #budget-message-box,
.card,
.chart-card,
.transactions,
.reminders,
.upcoming-bills {
  background-color: #f9fafc; /* Subtly cooler white */
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
}
    
    /* --------------------------------
       DASHBOARD CARDS
    -------------------------------- */
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .card {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.07);
      text-align: center;
      transition: transform 0.2s;
    }
    .card:hover {
      transform: scale(1.02);
    }
    .card h3 {
      margin-bottom: 10px;
      font-size: 16px;
      color: #6c4f3d;
    }
    .card p {
      font-size: 20px;
      font-weight: bold;
      color: #4a4a4a;
    }
    
    /* --------------------------------
       CHARTS
    -------------------------------- */
    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 30px; /* Increase gap for bigger spacing */
      margin-bottom: 30px;
    }
    .chart-card {
      background-color: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.07);
      text-align: center;
      transition: transform 0.2s;
      height: 350px; /* Larger chart container */
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .chart-card:hover {
      transform: scale(1.01);
    }
    .chart-card h3 {
      margin-bottom: 15px;
      font-size: 18px;
      color: #6c4f3d;
    }
    canvas {
      width: 100% !important;
      height: 90% !important;
      border-radius: 5px;
      background-color: #fff;
    }
    
    /* --------------------------------
       RECENT TRANSACTIONS (Existing)
    -------------------------------- */
    .transactions {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.07);
      margin: 0 auto 30px;
      max-width: 900px; /* bigger container */
      transition: transform 0.2s;
    }
    .transactions:hover {
      transform: scale(1.01);
    }
    .transactions h2 {
      font-size: 18px;
      font-weight: bold;
      color: #6c4f3d;
      margin-bottom: 15px;
      text-align: center;
    }
    .transactions table {
      width: 100%;
      border-collapse: collapse;
    }
    .transactions th,
    .transactions td {
      padding: 10px;
      border: 1px solid #d5d8dd;
      text-align: left;
      font-size: 14px;
    }
    .transactions th {
      background-color: #f2f4f7;
      color: #5e5450;
    }
    
    /* --------------------------------
       RECENT REMINDERS (New)
    -------------------------------- */
    .reminders {
      background-color: #fff;
      padding: 25px; /* bigger container */
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.07);
      max-width: 900px; /* bigger container */
      margin: 0 auto 30px;
      transition: transform 0.2s;
    }
    .reminders:hover {
      transform: scale(1.01);
    }
    .reminders h2 {
      font-size: 18px;
      font-weight: bold;
      color: #6c4f3d;
      margin-bottom: 15px;
      text-align: center;
    }
    .reminders ul {
      list-style: none;
    }
    .reminders li {
      padding: 10px;
      border-bottom: 1px solid #e0dcd8;
      font-size: 14px;
    }
    .reminders li:last-child {
      border-bottom: none;
    }
    
    /* --------------------------------
       UPCOMING BILLS (New)
    -------------------------------- */
    .upcoming-bills {
      background-color: #fff;
      padding: 25px; /* bigger container */
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.07);
      max-width: 900px; /* bigger container */
      margin: 0 auto 30px;
      transition: transform 0.2s;
    }
    .upcoming-bills:hover {
      transform: scale(1.01);
    }
    .upcoming-bills h2 {
      font-size: 18px;
      font-weight: bold;
      color: #6c4f3d;
      margin-bottom: 15px;
      text-align: center;
    }
    .upcoming-bills ul {
      list-style: none;
    }
    .upcoming-bills li {
      padding: 10px;
      border-bottom: 1px solid #e0dcd8;
      font-size: 14px;
    }
    .upcoming-bills li:last-child {
      border-bottom: none;
    }

        /* Profile container positioned in upper right corner */
        .profile-container {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      align-items: center;
      z-index: 10000;
    }
    /* Message Icon styling */
    #message-icon {
      font-size: 24px;
      cursor: pointer;
      color: #8F7D6F;
      margin-right: 8px;
    }
    #message-icon:hover {
      color: #837568;
    }
    /* Profile picture styling */
    #profile-picture {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: #ccc; /* default; will be replaced by random color */
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: white;
      margin-right: 10px;
    }

    #profile-initial {
  color: #000000;        /* Ensure contrast against the background */
  font-size: 24px;
  font-weight: bold;
}

    
   
  </style>
</head>
<body>
  

  <!-- Profile Container in Upper Right -->
<div class="profile-container">
 
  <div id="profile-picture">
    <span id="profile-initial"></span>
  </div>
</div>

 
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="logo">
      <i class="fas fa-bars"></i>
      <span>TETFinance</span>
    </div>
    <ul class="menu">
      <li>
        <a href="#" class="active">
          <i class="fas fa-home"></i>
          <span>Общ преглед</span>
        </a>
      </li>
      <li>
        <a href="/minipages/transactions.html">
          <i class="fas fa-exchange-alt"></i>
          <span>Транзакции</span>
        </a>
      </li>
      <li>
        <a href="/minipages/charts.html">
          <i class="fas fa-chart-pie"></i>
          <span>Визуализация</span>
        </a>
      </li>
      <li>
        <a href="/minipages/budget.html">
          <i class="fas fa-wallet" id="budgetRotator"></i>
          <span >Бюджети</span>
        </a>
      </li>
      <li>
        <a href="/minipages/goals.html">
          <i class="fas fa-bullseye"></i>
          <span>Цели</span>
        </a>
      </li>
      <li>
        <a href="/minipages/AskFinance.html">
          <i class="fas fa-question-circle"></i>
          <span>Финанс бот</span>
        </a>
      </li>
      <li>
        <a href="/minipages/settings.html">
          <i class="fas fa-cog"></i>
          <span>Настройки</span>
        </a>
      </li>
    </ul>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content">
    <header>
      <h1>Общ преглед</h1>
      <p>Направи бърз преглед на баланса, бюджетите и последните си активности.</p>
    </header>

    <!-- Larger Budgets Container -->
    <div id="budget-message-box">
      <h3>Бюджети</h3>
      <p id="budget-message">Loading...</p>
    </div>

    <!-- Dashboard Cards -->
    <section class="dashboard-cards">
      <div class="card" id="incomeCard">
        <h3>Доходи за този месец </h3>
        <p style="color: #28a745;"></p>
      </div>
      <div class="card" id="expenseCard">
        <h3>Разходи за този месец</h3>
        <p style="color: #dc3545;"></p>
      </div>
      <div class="card" id="balanceCard">
        <h3>Баланс</h3>
        <p style="color: #007bff;"></p>
      </div>
    </section>

    <!-- Charts with bigger spacing & bigger container height -->
    <section class="charts">
      <div class="chart-card">
        <h3>Разпределение на разходите</h3>
        <canvas id="expenseChart"></canvas>
      </div>
      <div class="chart-card">
        <h3>Доходи срещу разходи</h3>
        <canvas id="incomeExpenseChart"></canvas>
      </div>
    </section>

    <!-- Example of an existing transactions container -->
    <div class="transactions">
      <h2>Скорошни транзакции</h2>
      <table>
        <thead>
          <tr>
            <th>Дата</th>
            <th>Описание</th>
            <th>Брой ($)</th>
            <th>Тип</th>
          </tr>
        </thead>
        <tbody id="transactionsTableBody">
          <!-- Example data or dynamic script -->
        </tbody>
      </table>
    </div>

    <!-- Recent Reminders container -->
<section class="reminders" id="remindersContainer">
  <h2>Скорошни напомняния</h2>
  <ul id="remindersList"></ul>
</section>


    <!-- Upcoming bills container sized up -->
    <section class="upcoming-bills">
      <h2>Предстоящи плащания</h2>
      <ul>
        <li>Electricity Bill - Due: Mar 05 - $120.00</li>
        <li>Water Bill - Due: Mar 10 - $45.00</li>
        <li>Internet - Due: Mar 15 - $60.00</li>
      </ul>
    </section>
  </div>

  <!-- CHART SCRIPTS -->
  <script type="module">
     import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
     import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged,setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
     import { getDatabase, ref, set, get, update } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    
  // ✅ Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBu294QDq5U5sipx8LmIRgZTfvSL7GA_sM",
    authDomain: "personalfinancetrackerdb.firebaseapp.com",
    databaseURL: "https://personalfinancetrackerdb-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "personalfinancetrackerdb",
    storageBucket: "personalfinancetrackerdb.appspot.com",
    messagingSenderId: "404141477300",
    appId: "1:404141477300:web:90d2185768e64c6169b6e1",
    measurementId: "G-9H4NRQ68DJ"
  };

  

  // ✅ Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const user = auth.currentUser;
  if (user) {
  const userId = user.uid;
  // now do get(ref(db, `users/${userId}/...`))
}
setPersistence(auth, browserLocalPersistence)
.catch((error) => console.error("Persistence error:", error));



// Helper function to get the username from your database.
async function getUsername(userId) {
  try {
    const snapshot = await get(ref(db, `users/${userId}/username`));
    return snapshot.exists() ? snapshot.val() : null;
  } catch (error) {
    console.error("Error fetching username:", error);
    return null;
  }
}

// Listen for auth state changes once the DOM is fully loaded.
document.addEventListener("DOMContentLoaded", () => {
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const userId = user.uid;
      // Retrieve username from database; if not found, fallback.
      let username = await getUsername(userId);
      if (!username) {
        username = user.displayName || "Anonymous";
      }
      console.log(user.email);
     
      // Set the profile picture with the username's first initial.
      if (localStorage.getItem("profilePictureBase64")) {
    updateProfilePicture();
  }
      else{setProfilePicture(username);
      }      
      // Continue with other UI updates (e.g., displayData)
      await displayData();
      console.log("Auth state changed: user is logged in.");
    } else {
      // No user logged in: show dummy data.
      displayDummyData();
      console.log("Auth state changed: no user logged in.");
    }
  });
});




function displayDummyData() {
  // Update dashboard cards with dummy values:
  const cards = document.querySelectorAll(".dashboard-cards .card p");
  if (cards.length >= 3) {
    cards[0].textContent = "$15,000.00";
    cards[1].textContent = "$1,622.29";
    cards[2].textContent = "$11,500.00";
  }
  
  // Update charts with dummy data:
  updateIncomeExpenseChart(true);  // assuming your functions accept a forceDummy flag
  updateExpenseChart(true);

  // Update transactions table with dummy data:
  updateTransactionsTable(true);

  // Update upcoming bills with dummy data:
  loadUpcomingBills(true);
  loadRecentReminders(true);


  // ... update any other UI parts with dummy content as needed.
}
  

async function updateSummaryCards(forceDummy = false) {
  const incomeEl = document.getElementById("incomeCard").querySelector("p");
  const expenseEl = document.getElementById("expenseCard").querySelector("p");
  const balanceEl = document.getElementById("balanceCard").querySelector("p");

  if (!incomeEl || !expenseEl || !balanceEl) return;

  // Ако сме задали forceDummy или няма логнат потребител, показваме dummy данни.
  const user = auth.currentUser;
  if (forceDummy || !user) {
    incomeEl.textContent = "$5,500";
    expenseEl.textContent = "$3,200";
    balanceEl.textContent = "$2,300";
    return;
  }

  // Определяме диапазона:
  // 1. Изчисляваме първия ден на текущия месец.
  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth(); // 0-базирано (0 = януари)
  const firstOfMonth = new Date(currentYear, currentMonth, 1);
  
  // 2. Изчисляваме разликата в дни между първия ден и сега.
  const msPerDay = 24 * 60 * 60 * 1000;
  const diffDays = Math.floor((now - firstOfMonth) / msPerDay) + 1; // +1 за включване на деня
  
  // 3. Ако разликата е над 30 дни, използваме последните 30 дни; иначе - от първия ден на месеца.
  let startDate;
  if (diffDays > 30) {
    // Понеже искаме 30 дни, включително днешния, пресмятаме:
    startDate = new Date(now.getTime() - (30 - 1) * msPerDay);
  } else {
    startDate = firstOfMonth;
  }
  
  // Крайна дата винаги ще бъде сега.
  const endDate = now;
  
  // Преобразуваме датите във формат YYYY-MM-DD
  const startStr = startDate.toISOString().split("T")[0];
  const endStr = endDate.toISOString().split("T")[0];
  
  // Функция за проверка дали дадена дата (във формат YYYY-MM-DD) попада в диапазона.
  function isInRange(dateStr) {
    return dateStr && dateStr >= startStr && dateStr <= endStr;
  }
  
  let totalIncome = 0;
  let totalExpenses = 0;
  
  try {
    const userId = user.uid;
    // Четем доходите от Firebase
    const incomesRef = ref(db, `users/${userId}/incomeRecords`);
    const incomesSnap = await get(incomesRef);
    if (incomesSnap.exists()) {
      const incomesData = incomesSnap.val();
      for (const key in incomesData) {
        const record = incomesData[key];
        if (record.date && isInRange(record.date)) {
          totalIncome += Number(record.amount) || 0;
        }
      }
    }
    
    // Четем разходите от Firebase
    const expensesRef = ref(db, `users/${userId}/transactions`);
    const expensesSnap = await get(expensesRef);
    if (expensesSnap.exists()) {
      const expensesData = expensesSnap.val();
      for (const key in expensesData) {
        const tx = expensesData[key];
        if (tx.date && isInRange(tx.date)) {
          totalExpenses += Number(tx.amount) || 0;
        }
      }
    }
    
    const netBalance = totalIncome - totalExpenses;
    
    // Обновяваме картите
    incomeEl.textContent = `$${totalIncome.toLocaleString()}`;
    expenseEl.textContent = `$${totalExpenses.toLocaleString()}`;
    balanceEl.textContent = `$${netBalance.toLocaleString()}`;
    
    console.log("Start Date:", startStr, "End Date:", endStr);
    console.log("Total Income:", totalIncome, "Total Expenses:", totalExpenses, "Net Balance:", netBalance);
    
  } catch (error) {
    console.error("Error updating summary cards:", error);
    incomeEl.textContent = "Няма налични данни към момента";
    expenseEl.textContent = "Няма налични данни към момента";
    balanceEl.textContent = "Няма налични данни към момента";
  }
}


export async function fetchExpenseChartData(userId) {
  const db = getDatabase();
  // Change "transactions" to "Transactions" if that's how your data is stored
  const expenseRef = ref(db, `users/${userId}/transactions`); 
  try {
    const snapshot = await get(expenseRef);
    if (!snapshot.exists()) {
      // No transactions exist
      return null;
    }
    
    // Grab all transactions
    const allTransactions = snapshot.val();
    
    // Aggregate transactions by their category.
    const categorySums = {};
    for (const txId in allTransactions) {
      const tx = allTransactions[txId];
      const category = tx.category || "Other";
      const amount = parseFloat(tx.amount);
      if (!isNaN(amount)) {
        categorySums[category] = (categorySums[category] || 0) + amount;
      }
    }
    
    // Build arrays for labels and data.
    const labels = Object.keys(categorySums);
    const data = Object.values(categorySums);
    
    if (labels.length === 0) {
      return null;
    }
    
    return {
      labels: labels,
      datasets: [
        {
          data: data,
          backgroundColor: labels.map(() => randomColor())
        }
      ]
    };
  } catch (error) {
    console.error("Error fetching expense chart data:", error);
    return null;
  }
}

let expenseChartInstance = null; // a global or higher-scope variable
async function updateExpenseChart(forceDummy = false) {
  const canvas = document.getElementById("expenseChart");
  if (!canvas) return;
  const container = canvas.parentElement;

  let chartData = null;
  const user = auth.currentUser;

  // If forcing dummy data or user is not authenticated => dummy chart
  if (forceDummy || !user) {
    chartData = {
      labels: ["Groceries", "Rent", "Utilities", "Entertainment"],
      datasets: [
        {
          data: [100, 500, 75, 40],
          backgroundColor: ["#ff6384", "#36a2eb", "#ffcd56", "#4bc0c0"]
        }
      ]
    };
  } else {
    try {
      const userId = user.uid;
      const fetchedData = await fetchExpenseChartData(userId);
      if (!fetchedData) {
        // Means no transactions or all zero => show message
        container.innerHTML = "<p style='text-align:center;'>Няма налични данни към момента</p>";
        return;
      }
      chartData = fetchedData;
    } catch (error) {
      console.error("Error updating expense chart:", error);
      container.innerHTML = "<p style='text-align:center;'>Няма налични данни към момента</p>";
      return;
    }
  }

  // Destroy old chart instance if it exists
  if (expenseChartInstance) {
    expenseChartInstance.destroy();
  }

  // Create a new Chart.js pie chart
  const ctx = canvas.getContext("2d");
  expenseChartInstance = new Chart(ctx, {
    type: "pie",
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });
}
// Optional helper to generate a random color for each category

    // --- Functions to Fetch Chart Data from Firebase or Use Dummy Data ---
    export async function fetchIncomeExpenseChartData(requestedUserId) {
  // 1. Ensure user is authenticated and has matching userId.
  const auth = getAuth();
  const currentUser = auth.currentUser;
  if (!currentUser || currentUser.uid !== requestedUserId) {
    throw new Error("Unauthorized: User is not authenticated or does not match requestedUserId.");
  }

  try {
    const db = getDatabase();

    // Paths must match your DB structure exactly.
    // Security Rules:
    // "incomeRecords" and "Transactions" should be children of
    // "users/$userID" that require auth.uid == $userID to read.
    const incomesRef = ref(db, `users/${requestedUserId}/incomeRecords`);
    const expensesRef = ref(db, `users/${requestedUserId}/transactions`);

    // Fetch both income and expense records in parallel
    const [incomesSnap, expensesSnap] = await Promise.all([
      get(incomesRef),
      get(expensesRef),
    ]);

    // If no data exists, default to empty objects
    const incomesData = incomesSnap.exists() ? incomesSnap.val() : {};
    const expensesData = expensesSnap.exists() ? expensesSnap.val() : {};

    // 2. Validate & aggregate incomes by "YYYY-MM"
    const monthlyIncome = {};
    for (const key in incomesData) {
      const record = incomesData[key];
      if (!record) continue;

      // Check "date" format: must be a non-empty string matching YYYY-MM-DD
      if (
        typeof record.date !== "string" ||
        !/^\d{4}-\d{2}-\d{2}$/.test(record.date)
      ) {
        continue; // skip invalid date
      }

      // Extract "YYYY-MM"
      const month = record.date.slice(0, 7);

      // Check "amount": must be a number >= 0
      const amount = parseFloat(record.amount);
      if (isNaN(amount) || amount < 0) {
        continue; // skip invalid amount
      }

      // Accumulate
      if (!monthlyIncome[month]) monthlyIncome[month] = 0;
      monthlyIncome[month] += amount;
    }

    // 3. Validate & aggregate expenses by "YYYY-MM"
    const monthlyExpenses = {};
    for (const key in expensesData) {
      const record = expensesData[key];
      if (!record) continue;

      // Check "date" format: must be a non-empty string matching YYYY-MM-DD
      if (
        typeof record.date !== "string" ||
        !/^\d{4}-\d{2}-\d{2}$/.test(record.date)
      ) {
        continue; // skip invalid date
      }

      // Extract "YYYY-MM"
      const month = record.date.slice(0, 7);

      // Check "amount": must be a number >= 0
      const amount = parseFloat(record.amount);
      if (isNaN(amount) || amount < 0) {
        continue; // skip invalid amount
      }

      // Accumulate
      if (!monthlyExpenses[month]) monthlyExpenses[month] = 0;
      monthlyExpenses[month] += amount;
    }

    // 4. Combine all unique months from incomes & expenses
    const allMonths = new Set([
      ...Object.keys(monthlyIncome),
      ...Object.keys(monthlyExpenses),
    ]);
    const sortedMonths = Array.from(allMonths).sort();

    // 5. Build data arrays for Chart.js
    const incomeDataArray = sortedMonths.map((m) => monthlyIncome[m] || 0);
    const expenseDataArray = sortedMonths.map((m) => monthlyExpenses[m] || 0);

    // Return final chart configuration
    return {
      labels: sortedMonths,
      datasets: [
        {
          label: "Income",
          data: incomeDataArray,
          // You can style your chart as needed.
          backgroundColor: "green",
          borderColor: "green",
          fill: false,
          borderWidth: 2,
        },
        {
          label: "Expenses",
          data: expenseDataArray,
          backgroundColor: "red",
          borderColor: "red",
          fill: false,
          borderWidth: 2,
        },
      ],
    };
  } catch (error) {
    console.error("Error fetching income vs expense chart data:", error);
    return null;
  }
}



   

let incomeExpenseChartInstance = null;
async function updateIncomeExpenseChart(forceDummy = false) {
  let chartData;
  const canvas = document.getElementById('incomeExpenseChart');
  if (!canvas) return;
  const container = canvas.parentElement;
  
  if (forceDummy) {
    // Use dummy data when forced.
    chartData = {
      labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
      datasets: [
        {
          label: 'Income',
          data: [1500, 1300, 1400, 1400],
          backgroundColor: '#28a745',
          borderColor: '#28a745',
          borderWidth: 2,
          fill: false
        },
        {
          label: 'Expenses',
          data: [800, 750, 900, 750],
          backgroundColor: '#dc3545',
          borderColor: '#dc3545',
          borderWidth: 2,
          fill: false
        }
      ]
    };
  } else {
    const user = auth.currentUser;
    if (!user) {
      // No authenticated user: fall back to dummy data.
      chartData = {
        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
        datasets: [
          {
            label: 'Income',
            data: [1500, 1300, 1400, 1400],
            backgroundColor: '#28a745',
            borderColor: '#28a745',
            borderWidth: 2,
            fill: false
          },
          {
            label: 'Expenses',
            data: [800, 750, 900, 750],
            backgroundColor: '#dc3545',
            borderColor: '#dc3545',
            borderWidth: 2,
            fill: false
          }
        ]
      };
    } else {
      const userId = user.uid;
      const fetchedData = await fetchIncomeExpenseChartData(userId);
      if (fetchedData) {
        chartData = fetchedData;
      } else {
        chartData = null;
      }
    }
  }
  
  // If chartData is null (i.e. no data) and the user is authenticated, show a message.
  if (chartData === null && auth.currentUser) {
    container.innerHTML = "<p style='text-align:center;'>Няма налични данни към момента</p>";
    return;
  }
  
  // Ensure the container is visible.
  container.style.display = "block";
  
  // Destroy any existing chart instance before creating a new one.
  if (incomeExpenseChartInstance) {
    incomeExpenseChartInstance.destroy();
  }
  
  const ctx = canvas.getContext('2d');
  incomeExpenseChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: chartData.labels,
      datasets: [
        {
          label: 'Доходи',
          data: chartData.datasets[0].data,
          backgroundColor: '#28a745',
          borderColor: '#28a745',
          borderWidth: 2,
          fill: false
        },
        {
          label: 'Разходи',
          data: chartData.datasets[1].data,
          backgroundColor: '#dc3545',
          borderColor: '#dc3545',
          borderWidth: 2,
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });
}




    function randomColor() {
  return "#" + Math.floor(Math.random() * 16777215).toString(16);
}




   // Declare budgets and index as global variables (or in your module scope)


   async function checkAndRotateBudgets() {
  const user = auth.currentUser;
  if (!user) return; // If no logged-in user, no budgets to show
  const userId = user.uid;
  
  try {
    // Read budgets from Firebase (adjust path if needed)
    const budgetsRef = ref(db, `users/${userId}/budgetCategories/`);
    const budgetsSnap = await get(budgetsRef);
    if (!budgetsSnap.exists()) return; // No budget data found
    
    const budgetsData = budgetsSnap.val();
    
    // Convert the object of budgets into an array of { category, limit }
    const budgetsArray = [];
    for (const key in budgetsData) {
      const budget = budgetsData[key];
      budgetsArray.push({
        category: budget.category || key,       // Fallback to the key if no "category"
        limit: Number(budget.limit) || 0        // Convert limit to a number (fallback to 0)
      });
    }
    
    if (budgetsArray.length === 0) return; // Nothing to rotate
    
    // Grab the element where we want to show rotating budgets
    const budgetMessageEl = document.getElementById("budget-message");
    if (!budgetMessageEl) {
      console.error("Element with id 'budget-message' not found");
      return;
    }
    
    // Set up initial fade styles
    budgetMessageEl.style.opacity = 0;
    budgetMessageEl.style.transition = "opacity 0.5s ease-in-out";
    
    let currentIndex = 0;
    
    function showNextBudget() {
      const currentBudget = budgetsArray[currentIndex];
      // For example: "kjadfb: $5"
      budgetMessageEl.textContent = `${currentBudget.category}: $${currentBudget.limit.toLocaleString()}`;
      
      // Fade in
      budgetMessageEl.style.opacity = 1;
      
      // After 3 seconds, fade out
      setTimeout(() => {
        budgetMessageEl.style.opacity = 0;
        // Wait 500ms for fade out to finish, then show the next budget
        setTimeout(() => {
          currentIndex = (currentIndex + 1) % budgetsArray.length;
          showNextBudget();
        }, 500); 
      }, 3000); 
    }
    
    // Start the rotation
    showNextBudget();
    
  } catch (error) {
    console.error("Error fetching budgets:", error);
  }
}





async function updateTransactionsTable(forceDummy = false) {
  const tbody = document.getElementById('transactionsTableBody');
  tbody.innerHTML = ""; // Clear existing content

  // If forceDummy is true, show dummy transactions regardless of auth state.
  if (forceDummy) {
    const dummyTransactions = [
      { date: '2025-02-01', desc: 'Groceries', amount: 75.32, type: 'Expense' },
      { date: '2025-02-02', desc: 'Salary', amount: 1500.00, type: 'Income' },
      { date: '2025-02-03', desc: 'Electric Bill', amount: 60.00, type: 'Expense' },
      { date: '2025-02-05', desc: 'Dinner Out', amount: 45.90, type: 'Expense' }
    ];
    dummyTransactions.forEach(tx => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${tx.date}</td>
        <td>${tx.desc}</td>
        <td>${tx.amount.toFixed(1)}</td>
        <td>${tx.type}</td>
      `;
      tbody.appendChild(row);
    });
    return;
  }
  
  const user = auth.currentUser;
  if (!user) {
    // If no user is authenticated, also show dummy transactions.
    const dummyTransactions = [
      { date: '2025-02-01', desc: 'Groceries', amount: 75.32, type: 'Expense' },
      { date: '2025-02-02', desc: 'Salary', amount: 1500.00, type: 'Income' },
      { date: '2025-02-03', desc: 'Electric Bill', amount: 60.00, type: 'Expense' },
      { date: '2025-02-05', desc: 'Dinner Out', amount: 45.90, type: 'Expense' }
    ];
    dummyTransactions.forEach(tx => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${tx.date}</td>
        <td>${tx.desc}</td>
        <td>${tx.amount.toFixed(1)}</td>
        <td>${tx.type}</td>
      `;
      tbody.appendChild(row);
    });
    return;
  }

  // Authenticated: fetch real transactions
  try {
    const userId = user.uid;
    const transactionsSnap = await get(ref(db, `users/${userId}/transactions`));

    if (transactionsSnap.exists()) {
      transactionsSnap.forEach(childSnap => {
        const tx = childSnap.val();
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${tx.date || ''}</td>
          <td>${tx.description || ''}</td>
          <td>${Number(tx.amount || 0).toFixed(1)}</td>
          <td>${tx.category || ''}</td>
        `;
        tbody.appendChild(row);
      });
    } else {
      // Authenticated but no transactions: show message row
      const row = document.createElement('tr');
      row.innerHTML = `<td colspan="4" style="text-align: center;">Няма налични данни към момента</td>`;
      tbody.appendChild(row);
    }
  } catch (error) {
    console.error("Error updating transactions table:", error);
    const row = document.createElement('tr');
    row.innerHTML = `<td colspan="4" style="text-align: center;">Няма налични данни към момента</td>`;
    tbody.appendChild(row);
  }
}




//
// 
// REMINDER LOGIC

async function loadRecentReminders(forceDummy = false) {
  if (forceDummy) {
    showDummyRemindersDummy();
    return;
  }
  
  try {
    const user = auth.currentUser;
    if (!user) {
      // Not authenticated: show dummy reminders
      showDummyRemindersDummy();
      return;
    }
    const userId = user.uid;
    const snap = await get(ref(db, `users/${userId}/reminders`));
    if (!snap.exists()) {
      // Authenticated but no reminders: show message
      showNoDataForReminders();
      return;
    }
    // If data exists, process and display the real reminders
    const data = snap.val();
    // For example, sort the reminders and then display the top few:
    const reminderKeys = Object.keys(data);
    reminderKeys.sort((a, b) => (data[b].createdAt || 0) - (data[a].createdAt || 0));
    const topReminders = reminderKeys.slice(0, 3);
    const remindersList = document.getElementById("remindersList");
    remindersList.innerHTML = "";
    topReminders.forEach(key => {
      const reminder = data[key];
      const li = document.createElement("li");
      li.textContent = reminder.text || "No text";
      remindersList.appendChild(li);
    });
  } catch (error) {
    console.error("Error loading reminders:", error);
    showNoDataForReminders();
  }
}


function showNoDataForReminders() {
  const remindersList = document.getElementById("remindersList");
  remindersList.innerHTML = "";
  const li = document.createElement("li");
  li.textContent = "Няма налични данни към момента";
  li.style.textAlign = "center";
  remindersList.appendChild(li);
}

function showDummyRemindersDummy() {
  // Display dummy reminders for non-authenticated users if desired
  const remindersList = document.getElementById("remindersList");
  remindersList.innerHTML = "";
  const dummy = [
    { text: "Pay credit card bill" },
    { text: "Review monthly subscriptions" },
    { text: "Set up weekly savings transfer" },
  ];
  dummy.forEach((item) => {
    const li = document.createElement("li");
    li.textContent = item.text;
    remindersList.appendChild(li);
  });
}




// ————————————————————————————————
// Fallback when there are no upcoming bills
function showNoDataForBills() {
  const ul = document.querySelector('.upcoming-bills ul');
  if (!ul) return;

  ul.innerHTML = '';                  // clear out any old list items
  const li = document.createElement('li');
  li.textContent = 'Няма налични данни към момента';
  li.style.textAlign = 'center';      // center it like your other messages
  ul.appendChild(li);
}
// ————————————————————————————————


// Function to load and display upcoming bills from ScheduledTransactions
  async function loadUpcomingBills(forceDummy = false) {
  const upcomingBillsUl = document.querySelector(".upcoming-bills ul");
  upcomingBillsUl.innerHTML = ""; // Clear old content

  // 1) Dummy mode?
  if (forceDummy) {
    showDummyBills();
    return;
  }

  // 2) Are we logged in?
  const user = auth.currentUser;
  if (!user) {
    showNoDataForBills();
    return;
  }

  // 3) Fetch from Firebase Realtime Database
  try {
    const snap = await get(ref(db, `users/${user.uid}/scheduledTransactions`));
    if (!snap.exists()) {
      showNoDataForBills();
      return;
    }
    // 4) We have data — iterate and render
    const data = snap.val(); // object: { key1: {date,category,amount,description,…}, … }
    // Sort by date or by creation timestamp, if you like:
    const entries = Object.entries(data)
                          .sort(([,a],[,b]) => new Date(a.date) - new Date(b.date));

    entries.forEach(([id, bill]) => {
      const li = document.createElement("li");
      li.textContent = `${bill.description} — Due: ${bill.date} — $${Number(bill.amount).toFixed(2)}`;
      upcomingBillsUl.appendChild(li);
    });
  } catch (err) {
    console.error("Error loading scheduled transactions:", err);
    showNoDataForBills();
  }
}





async function displayData() {
  const user = auth.currentUser;
  if (user) {
    // If authenticated, update all UI components with real data:
    await updateIncomeExpenseChart(); // loads the income vs. expense line chart
    await updateExpenseChart();         // loads the expense pie chart
    await updateTransactionsTable();    // updates the transactions table
    await loadUpcomingBills();  
    await loadRecentReminders();
    await updateSummaryCards(); // updates the summary cards
    await checkAndRotateBudgets();
    const privacyModeEnabled = JSON.parse(localStorage.getItem("privacyModeEnabled")) || false;
if (privacyModeEnabled) {
  enablePrivacyMode();
}            // updates upcoming bills section
    // ... call any other functions to fetch and display real data.
  } else {
    // If not authenticated, show dummy data for all components:
    displayDummyData();
  }
}


/************************************************
   * PROFILE LOGIC 
   ***********************************************/
      window.app = app; // Expose if needed

      // This function updates the profile picture container using the saved image in localStorage.
function updateProfilePicture() {
  const profileContainer = document.getElementById("profile-picture");
  const base64Pic = localStorage.getItem("profilePictureBase64");
  console.log("updateProfilePicture called, base64Pic:", base64Pic);
  
  if (base64Pic) {
    profileContainer.style.backgroundImage = `url(${base64Pic})`;
    profileContainer.style.backgroundSize = "cover";
    profileContainer.style.backgroundPosition = "center";
    // Clear any inner HTML (like initials)
    profileContainer.innerHTML = "";
  } else {
    console.log("No profile picture found in localStorage.");
  }
}

/** Wrap everything that references the DOM in DOMContentLoaded **/
document.addEventListener("DOMContentLoaded", () => {
  
  function setProfilePicture(username) {
  if (!username) return; // If no username is provided, exit the function.
  
  // Get the HTML elements that display the profile initial and container.
  const initialEl = document.getElementById('profile-initial');
  const pictureEl = document.getElementById('profile-picture');
  
  // If either element doesn't exist in the DOM, exit to avoid errors.
  if (!initialEl || !pictureEl) return;

  // Get the first character of the username, convert it to uppercase.
  const initial = username.charAt(0).toUpperCase();
  
  // Set the text content of the element that shows the initial.
  initialEl.textContent = initial;

  // Generate a random color for the background.
  const randomColor = '#' + Math.floor(Math.random() * 16777215).toString(16);
  
  // Apply the random background color to the profile picture container.
  pictureEl.style.backgroundColor = randomColor;
}

  window.setProfilePicture = setProfilePicture;
});
  </script>
    <script src="/features/privacyMode.js"></script>

</body>
</html>
