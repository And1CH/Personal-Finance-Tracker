<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Settings</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- jQuery UI CSS -->
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
  <link rel="stylesheet" type="text/css" href="/features/ProfileStyle.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js">
</script>
<script type="text/javascript">
   (function(){
      emailjs.init({
        publicKey: "CVlL4G0KFS12d7itb",
      });
   })();
</script>

  <style>
    /* Global Reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      font-family: Arial, sans-serif;
      background-color: #F2F4F7;
      color: #353A40;
      display: flex;
      height: 100vh;
    }
    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0; bottom: 0; left: 0;
      width: 60px; /* Collapsed width */
      background-color: #f9f9f9;
      border-right: 1px solid #ddd;
      overflow: hidden;
      transition: width 0.3s ease;
      z-index: 1000;
    }
    .sidebar:hover { width: 200px; }
    .sidebar .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 15px;
      color: #111;
      font-size: 18px;
      font-weight: bold;
      white-space: nowrap;
      transition: padding 0.3s ease;
    }
    .sidebar:hover .logo { justify-content: flex-start; padding-left: 15px; }
    .sidebar .logo i { margin-right: 10px; margin-left: 8px; }
    .sidebar .logo span { display: none; }
    .sidebar:hover .logo span { display: inline-block; }
    .menu { list-style: none; padding: 0; margin-top: 20px; }
    .menu li { text-align: center; margin-bottom: 15px; }
    .menu li a {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #555;
      text-decoration: none;
      font-size: 16px;
      padding: 10px 15px;
      transition: justify-content 0.3s ease, background-color 0.3s ease;
    }
    .sidebar:hover .menu li a { justify-content: flex-start; padding-left: 20px; }
    .menu li a:hover { background-color: #8F7D6F; color: #fff; }
    .menu li a i { font-size: 18px; }
    .menu li a span { display: none; margin-left: 10px; }
    .sidebar:hover .menu li a span { display: inline-block; }
    .menu li a.active { color: #8F7D6F; }
    .menu li a:hover { background-color: #8F7D6F; color: #fff; }
    
    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 60px;
      padding: 20px;
      transition: margin-left 0.3s ease;
      text-align: center;
      position: relative;
    }
    .sidebar:hover ~ .main-content {
      margin-left: 200px;
      width: calc(100% - 200px);
    }
    
    /* Header */
    header {
      text-align: center;
      margin-bottom: 30px;
      position: relative;
      cursor: move; /* Draggable cue */
    }
    header h1 { font-size: 28px; font-weight: bold; color: #353A40; margin-bottom: 5px; }
    header p { font-size: 16px; color: #585E64; margin-bottom: 20px; }
    
    /* Settings Cards Container */
    .settings-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 0;
    }
    .settings-card {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.07);
      text-align: center;
      transition: transform 0.2s;
      cursor: move;
      overflow: hidden;
    }
    .settings-card:hover { transform: scale(1.02); }
    .settings-card h3 { margin-bottom: 10px; font-size: 18px; color: #353A40; }
    .settings-card button {
      background-color: #8F7D6F;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .settings-card button:hover { background-color: #837568; }
    
    /* Profile Card */
    #card-profile {
      height: 120px;
      margin-top: -30px;
      position: relative;
    }
    .profile-menu {
      position: absolute;
      width: 100%;
      top: 50px;
      display: block;
      opacity: 0;
      transform: translateY(15px);
      margin-top: 15px;
      text-align: left;
      transition: opacity 0.5s, transform 0.5s;
    }
    .profile-menu form div { margin-bottom: 10px; }
    .profile-menu label {
      font-size: 0.9rem;
      color: #353A40;
      margin-bottom: 5px;
      display: block;
    }
    .profile-menu input {
      width: 90%;
      padding: 6px;
      font-size: 0.9rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    /* Draggable button containers for Profile Save and Cancel */
    #save-button, #cancel-button {
      position: absolute;
      bottom: 10px;
    }
    #save-button { left: 130px; bottom: -45px; }
    #cancel-button { left: 200px; bottom: -45px; }
    #save-button button, #cancel-button button {
      background-color: #8F7D6F;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #save-button button:hover, #cancel-button button:hover {
      background-color: #837568;
    }
    
    /* Notification Card */
    #card-notifications {
      height: 120px;
      margin-top: -30px;
      position: relative;
    }
    .notification-menu {
      position: absolute;
      width: 100%;
      top: 50px;
      display: block;
      opacity: 0;
      transform: translateY(15px);
      margin-top: 5px;
      text-align: left;

      transition: opacity 0.5s, transform 0.5s;
    }
    /* Toggle Switch CSS */
    .toggle-container {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      margin-right: 23px;
    }
    .toggle-container span {
      flex: 1;
      font-size: 0.9rem;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #8F7D6F;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    
    /* Draggable Notification Cancel Button */
    #notification-cancel {
      position: absolute;
      bottom: -30px;
      right: 180px;
    }
    #notification-cancel button {
      background-color: #8F7D6F;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #notification-cancel button:hover {
      background-color: #837568;
    }

    #notification-save {
      position: absolute;
      bottom: -30px;
      right: 260px;
    }
    #notification-save button {
      background-color: #8F7D6F;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #notification-save button:hover {
      background-color: #837568;
    }

#card-privacy {
  height: 120px;}
                  /* Privacy Menu Hidden by Default */
.privacy-menu {
  position: absolute;
  width: 100%;
  top: 30px;           /* Raised up compared to previous 50px */
  display: block;
  opacity: 0;
  transform: translateY(15px);
  margin-top: 20px;     /* Reduced margin so it sits higher */
  text-align: left;
  transition: opacity 0.5s, transform 0.5s;
  padding-bottom: 60px; /* Space for draggable button(s) */

}

/* Toggle Switches for Privacy Menu */
.toggle-container {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
}
.toggle-container span {
  font-size: 0.9rem;
  margin-right: 10px;  /* Small spacing so toggles don't get pushed too far right */
}
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 24px;
  margin-left: 0;  /* Ensure no extra left margin */
}
.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: 0.4s;
  border-radius: 34px;
}
.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.4s;
  border-radius: 50%;
}
input:checked + .slider {
  background-color: #8F7D6F;
}
input:checked + .slider:before {
  transform: translateX(26px);
}

/* Draggable Privacy Cancel Button Container */
#privacy-cancel {
  position: absolute;
  bottom: 20px;
  right: 180px;
}

#privacy-cancel button {
  background-color: #8F7D6F;
  color: white;
  padding: 8px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s;
}
#privacy-cancel button:hover {
  background-color: #837568;
}

.privacy-menu {
  pointer-events: none;
}



#privacy-save {
  position: absolute;
  bottom: 20px;
  right: 260px;
}
#privacy-save button {
  background-color: #8F7D6F;
  color: white;
  padding: 8px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s;
}
#privacy-save button:hover {
  background-color: #837568;
}

.privacy-menu {
  pointer-events: none;
}









                                      /* Security Settings Card */
/* Security Settings Card */
#card-security {
  /* your existing styles for the card: */
  background-color: #fff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.07);
  text-align: center;
  transition: transform 0.2s;
  cursor: move;
  overflow: hidden;
  /* The card will start at 120px tall */
  height: 120px;
  position: relative; /* so the menu can be absolutely positioned inside */
}

/* The hidden security menu that slides/fades in */
.security-menu {
  position: absolute;
  top: 30px;
  width: 100%;
  display: block;
  opacity: 0;                 /* invisible initially */
  transform: translateY(15px);/* slid down initially */
  pointer-events: none;       /* so it doesn't block clicks when hidden */
  transition: opacity 0.5s, transform 0.5s;
  text-align: left;
  padding-bottom: 60px; 
  margin-top: 20px;      /* space for the draggable Cancel button */
}

.security-menu form div {
  margin-bottom: 10px;
}
.security-menu label {
  font-size: 0.9rem;
  color: #353A40;
  margin-bottom: 5px;
  display: block;
}
.security-menu input {
  width: 90%;
  padding: 6px;
  font-size: 0.9rem;
  border: 1px solid #ccc;
  border-radius: 4px;
}


/* Each security option row */
.security-option {
  margin-bottom: 10px;
}

/* Draggable Cancel button container */
#security-cancel {
  position: absolute;
  bottom: 20px;
  left: 200px;
}
#security-cancel button {
  background-color: #8F7D6F;
  color: white;
  padding: 8px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s;
}
#security-cancel button:hover {
  background-color: #837568;
}


#security-save {
  position: absolute;
  bottom: 20px;
  left: 140px;
}
#security-save button {
  background-color: #8F7D6F;
  color: white;
  padding: 8px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s;
}
#security-save button:hover {
  background-color: #837568;
}

/* Example styling for toggle container, consistent with your existing toggles */
.toggle-container {
  display: flex;
  align-items: center;
  justify-content: space-between; /* text on left, toggle on right */
  margin-bottom: 10px;
}
.toggle-container span {
  font-size: 0.9rem;
  margin-right: 10px;
}
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 24px;
}
.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: #ccc;
  transition: 0.4s;
  border-radius: 34px;
}
.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: #fff;
  transition: 0.4s;
  border-radius: 50%;
}
input:checked + .slider {
  background-color: #8F7D6F;
}
input:checked + .slider:before {
  transform: translateX(26px);
}






    #lockModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    display: none; /* hidden by default */
    align-items: center;
    justify-content: center;
  }
  .lock-container {
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    width: 300px;
  }
  .lock-container h2 {
    margin-bottom: 20px;
    color: #353A40;
  }
  .lock-container p {
    margin-bottom: 20px;
    color: #585E64;
  }
  .lock-container input {
    width: 100%;
    padding: 10px;
    margin-bottom: 20px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  .lock-container button {
    background-color: #8F7D6F;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  .lock-container button:hover {
    background-color: #837568;
  }

   /* Profile container positioned in upper right corner */
   .profile-container {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      align-items: center;
      z-index: 10000;
    }
    /* Message Icon styling */
    
    /* Profile picture styling */
    #profile-picture {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: #ccc; /* default; will be replaced by random color */
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: white;
      margin-left: 10px;
    }
    #profile-initial {
  color: #000000;        /* Ensure contrast against the background */
  font-size: 24px;
  font-weight: bold;
}

    /* -----------------------
       MESSAGE POPUP + MENU
    ------------------------ */
    #messageModal {
      position: fixed;
      top: 0; 
      left: 0;
      width: 100%; 
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none; /* hidden by default */
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .message-container {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 400px;
      max-width: 90%;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.5s, transform 0.5s;
    }
    .message-container h2 {
      margin-bottom: 15px;
      color: #353A40;
      text-align: center;
    }
    .form-group {
      margin-bottom: 15px;
      text-align: left;
    }
    .form-group label {
      font-size: 0.9rem;
      margin-bottom: 5px;
      display: block;
      color: #353A40;
    }
    .form-group input[type="text"],
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    textarea { 
      resize: vertical; 
    }
    .modal-buttons {
      text-align: right;
      margin-top: 15px;
    }
    .modal-buttons button {
      background-color: #8F7D6F;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 5px;
      transition: background-color 0.3s;
    }
    .modal-buttons button:hover {
      background-color: #837568;
    }

    /* ---------------------------
       DATA SHARING MINI MENU
    ---------------------------- */
    .data-sharing-container {
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-bottom: 15px;
      overflow: hidden; /* hides content if we set a fixed height */
      transition: height 0.5s; /* animate the height change */
    }
    /* Title row (always visible) */
    .data-sharing-title {
      background: #f9f9f9;
      padding: 10px;
      display: flex;
      align-items: center;
      font-weight: bold;
      font-size: 0.95rem;
      color: #555;
    }
    .data-sharing-title i {
      margin-left: 8px;
      color: #aaa;
    }

    /* The expanded content that appears if data sharing is enabled */
    .data-sharing-expanded {
      padding: 10px;
      text-align: left;
      opacity: 0;           /* fade it in if we want */
      transform: translateY(10px);
      transition: opacity 0.5s, transform 0.5s;
    }
    .data-sharing-expanded-content {
      pointer-events: none; /* disabled by default (if locked) */
    }
    .data-sharing-expanded .form-group {
      margin-bottom: 10px;
    }
    .data-types label {
      margin-right: 10px;
    }


    /* Dark overlay background */
.otp-modal-overlay {
  position: fixed;
  top: 0; 
  left: 0;
  width: 100%; 
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 9999; 
  display: flex; 
  align-items: center; 
  justify-content: center;
}

/* Centered modal box */
.otp-modal-content {
  background: #fff;
  padding: 20px 30px;
  border-radius: 8px;
  text-align: center;
  max-width: 300px;
  width: 90%;
}

/* Optional styling for the input */
#otpInput {
  width: 100%;
  padding: 8px;
  font-size: 1rem;
  margin-top: 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

/* Buttons styling (adjust as needed) */
#otpSubmitButton, #otpCancelButton {
  background-color: #8F7D6F;
  color: white;
  padding: 10px 15px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  margin: 0 5px;
}
#otpSubmitButton:hover, #otpCancelButton:hover {
  background-color: #837568;
}

#password-toggle-icon {

position: absolute;
top: 35px;
right: 20px;         /* adjust as needed */
transform: translateY(-50%);
cursor: pointer;
font-size: 1.2rem;      /* icon size */
color: #666;
}

  </style>
</head>
<body>
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="logo">
      <i class="fas fa-bars"></i> <span>Finance Tracker</span>
    </div>
    <ul class="menu">
      <li><a href="/minipages/Overview.html"><i class="fas fa-home"></i><span>Overview</span></a></li>
      <li><a href="/minipages/transactions.html"><i class="fas fa-exchange-alt"></i><span>Transactions</span></a></li>
      <li><a href="/minipages/charts.html"><i class="fas fa-chart-pie"></i><span>Charts</span></a></li>
      <li><a href="/minipages/budget.html"><i class="fas fa-wallet"></i><span>Budget</span></a></li>
      <li><a href="/minipages/goals.html"><i class="fas fa-bullseye"></i><span>Goals</span></a></li>
      <li><a href="/minipages/AskFinance.html"><i class="fas fa-question-circle"></i><span>AskFinance</span></a></li>
      <li><a class="active" href="/minipages/settings.html"><i class="fas fa-cog"></i><span>Settings</span></a></li>
    </ul>
  </div>

  <!-- In settings.html, add this container in the body where you want the profile component to appear -->
 <!-- Profile Container in Upper Right -->
 <div class="profile-container">
  <div id="bell-icon" onclick="handleBellClick()" style="cursor:pointer; font-size:24px; color:#8F7D6F; margin-right:8px;">
    <i class="fas fa-bell"></i>
  </div>
 
  <div id="profile-picture">
    <span id="profile-initial"></span>
  </div>
</div>

<!-- OTP Modal (hidden by default) -->
<div id="otpModal" class="otp-modal-overlay" style="display:none;">
  <div class="otp-modal-content" id="otpModalContent">
    <h2>Enter One-Time Passcode</h2>
    <input type="text" id="otpInput" placeholder="6-digit code" />
    <div style="margin-top: 15px;">
      <button id="otpSubmitButton">Submit</button>
      <button id="otpCancelButton">Cancel</button>
    </div>
  </div>
</div>


  <!-- The Modal Overlay for sending messages -->
  <div id="messageModal">
    <div class="message-container" id="messageContainer">
      <h2>Send Message</h2>
      <form id="messageForm">
        <!-- Basic Fields -->
        <div class="form-group">
          <label for="toField">To:</label>
          <input type="text" id="toField" placeholder="Enter recipient name">
        </div>
        <div class="form-group">
          <label for="titleField">Title:</label>
          <input type="text" id="titleField" placeholder="Message title">
        </div>
        <div class="form-group">
          <label for="contentField">Content:</label>
          <textarea id="contentField" placeholder="Type your message here" rows="4"></textarea>
        </div>

        <!-- Data Sharing Mini Menu -->
        <div class="data-sharing-container" id="dataSharingContainer">
          <div class="data-sharing-title">
            Data Sharing
            <i class="fas fa-lock" id="lockIcon"></i>
          </div>
          <div class="data-sharing-expanded" id="dataSharingExpanded">
            <div class="data-sharing-expanded-content">
              <div class="form-group">
                <label style="font-weight: bold;">Type of Data</label>
                <div class="data-types">
                  <label><input type="checkbox" name="dataType" value="transactions"> Transactions</label>
                  <label><input type="checkbox" name="dataType" value="budgets"> Budgets</label>
                  <label><input type="checkbox" name="dataType" value="goals"> Goals</label>
                  <label><input type="checkbox" name="dataType" value="charts"> Charts</label>
                </div>
              </div>
              <div class="form-group">
                <label style="font-weight: bold;">Date Range</label>
                <div style="display: flex; gap: 10px;">
                  <div>
                    <label for="dataFrom">From:</label>
                    <input type="date" id="dataFrom">
                  </div>
                  <div>
                    <label for="dataTo">To:</label>
                    <input type="date" id="dataTo">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- End of Data Sharing Mini Menu -->

        <div class="modal-buttons">
          <button type="submit">Send</button>
          <button type="button" onclick="closeMessageModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content">
    <header id="settings-header">
      <h1>Settings</h1>
      <p>Customize your preferences and manage your account settings.</p>
    </header>

    <div class="settings-container">
      <!-- Profile Settings Card -->
      <div class="settings-card" id="card-profile">
        <h3>Profile Settings</h3>
        <button id="profileButton" onclick="expandProfileCard()">Edit Profile</button>
        
        <!-- Hidden content that appears upon expansion -->
        <div class="profile-menu">
          <form>
            <div>
              <label for="profileName">New Name:</label>
              <input type="text" id="profileName" placeholder="Your name" style="z-index: 99;" />
            </div>
            <label for="profilePic">Profile Picture:</label>
              <div class="file-upload-container">
                  <label for="profilePic" class="custom-file-upload">
                  <i class="fas fa-upload"></i> Choose File
                  </label>
                  <input type="file" id="profilePic" accept="image/*" style="display: none;">
              </div>

            <!-- Optional: Preview the selected image -->
            <div style="margin-top:10px;">
              <img id="profilePicPreview" alt="Profile Preview" 
                   style="display:none; width:80px; height:80px; border-radius:50%; object-fit:cover;" />
            </div>
            <!-- Draggable Save and Cancel button containers -->
            <div id="save-button">
              <button type="button" onclick="saveProfileChanges()">Save</button>
            </div>
            <div id="cancel-button">
              <button type="button" onclick="collapseProfileCard()">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Notification Settings Card -->
      <div class="settings-card" id="card-notifications">
        <h3>Notification Settings</h3>
        <button id="notificationButton" onclick="expandNotificationCard()">Notification Preferences</button>
        
        <!-- Hidden content for notification settings -->
        <div class="notification-menu">
          <div class="toggle-container">
            <span>Email notifications</span>
            <label class="toggle-switch">
              <input type="checkbox" id="emailToggle">
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-container">
            <span>Welcome notifications</span>
            <label class="toggle-switch">
              <input type="checkbox" id="welcomeToggle">
              <span class="slider"></span>
            </label>
          </div>
          <!-- Draggable Cancel button for notification settings -->
          <div id="notification-cancel">
            <button type="button" onclick="collapseNotificationCard()">Cancel</button>
          </div>
          <div id="notification-save">
            <button type="submit" >Save</button>
          </div>
        </div>
      </div>

     <!-- Privacy Settings Card -->
<div class="settings-card" id="card-privacy" style="position: relative">
  <h3>Privacy Settings</h3>
  <button id="privacyButton" onclick="expandPrivacyCard()">Privacy Controls</button>
  
  <!-- Hidden privacy menu -->
  <div class="privacy-menu">
    <div class="toggle-container">
      <span>Share data with 3rd parties</span>
      <label class="toggle-switch" for="shareDataToggle">
        <input type="checkbox" id="shareDataToggle">
        <span class="slider"></span>
      </label>
    </div>
   
    <div class="toggle-container">
      <span>Privacy Mode</span>
      <label class="toggle-switch">
        <input type="checkbox" id="privacyModeToggle">
        <span class="slider"></span>
      </label>
    </div>
    <div class="toggle-container">
      <span>Inactivity lock</span>
      <label class="toggle-switch">
        <input type="checkbox" id="inactivityLockToggle">
        <span class="slider"></span>
      </label>
    </div>
    <!-- Draggable Cancel button to collapse the menu -->
    <div id="privacy-cancel">
      <button type="button" onclick="collapsePrivacyCard()">Cancel</button>
    </div>

    <div id="privacy-save">
      <button type="button" onclick="collapsePrivacyCard()">Save</button>
    </div>
  </div>
</div>


<!-- Security Settings Card -->
<!-- Security Settings Card -->
<div class="settings-card" id="card-security">
  <h3>Security Settings</h3>
  <button id="securityButton" onclick="expandSecurityCard()">Change Settings</button>

  <!-- Hidden security menu that slides/fades in -->
  <div class="security-menu">
    <!-- Form layout similar to the Profile Settings style -->
    <form>
      <!-- Change Password Field -->
      <div>
        <label for="newPassword">Change Password:</label>
        <input type="password" id="newPassword" placeholder="Enter new password">
        <i
        id="password-toggle-icon"
        class="fa-solid fa-eye-slash toggle-password"
        onclick="togglePasswordVisibility('newPassword', this)"
      ></i>
      </div>

      <!-- Recovery Email Field -->
      <div>
        <label for="recoveryEmail">Recovery Email:</label>
        <input type="email" id="recoveryEmail" placeholder="Enter your recovery email">
      </div>

      <!-- Two-Factor Authentication Toggle -->
      <div class="toggle-container" style="margin-bottom: 10px;">
        <span>Two-Factor Authentication (highly recommended)</span>
        <label class="toggle-switch">
          <input type="checkbox" id="twoFactorToggle">
          <span class="slider"></span>
        </label>
      </div>

    

      <!-- Delete Account Button -->
      <div style="margin-top: 10px;">
        <button type="button" onclick="deleteAccount()">Delete Account</button>
      </div>

      <!-- Draggable Cancel button to collapse the card -->
      <div id="security-cancel">
        <button type="button" onclick="collapseSecurityCard()">Cancel</button>
      </div>

      <div id="security-save">
        <button id="securitySaveButton" type="button" >Save</button>
      </div>
    </form>
  </div>
</div>

  <div id="lockModal">
    <div class="lock-container">
      <h2>Session Locked</h2>
      <p>Please enter your password to unlock.</p>
      <input type="password" id="unlockPassword" placeholder="Password">
      <button onclick="unlock()">Unlock</button>
    </div>
  </div>
  

  <!-- jQuery & jQuery UI -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
  import { getDatabase, ref, set, get, update,remove } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";


// Firebase configuration – replace with your credentials


  // ✅ Firebase Configuration 
  const firebaseConfig = {
    apiKey: "AIzaSyBu294QDq5U5sipx8LmIRgZTfvSL7GA_sM",
    authDomain: "personalfinancetrackerdb.firebaseapp.com",
    databaseURL: "https://personalfinancetrackerdb-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "personalfinancetrackerdb",
    storageBucket: "personalfinancetrackerdb.appspot.com",
    messagingSenderId: "404141477300",
    appId: "1:404141477300:web:90d2185768e64c6169b6e1",
    measurementId: "G-9H4NRQ68DJ"
  };

  // ✅ Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // Helper function to get the username from your database.
async function getUsername(userId) {
  try {
    const snapshot = await get(ref(db, `users/${userId}/username`));
    return snapshot.exists() ? snapshot.val() : null;
  } catch (error) {
    console.error("Error fetching username:", error);
    return null;
  }
}

document.addEventListener("DOMContentLoaded", () => {
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const userId = user.uid;
      // Attempt to retrieve username from the database.
      let username = await getUsername(userId);
      // Fallback to displayName or default value if needed.
      if (!username) {
        username = user.displayName || "Anonymous";
      }
      console.log("Username determined:", username);
      
      if (localStorage.getItem("profilePictureBase64")) {
    updateProfilePicture();
  }
      else{setProfilePicture(username);
      }
      
      // Update your budget UI components (cards, charts, etc.).
      
    } else {
      // No user logged in; display dummy data.
      console.log("pruc.");
    }
  });
});


  window.togglePasswordVisibility = function(inputId, iconElement) {
    const passwordInput = document.getElementById(inputId);
    if (passwordInput.type === "password") {
      passwordInput.type = "text";
      iconElement.classList.remove("fa-eye-slash");
      iconElement.classList.add("fa-eye");
    } else {
      passwordInput.type = "password";
      iconElement.classList.remove("fa-eye");
      iconElement.classList.add("fa-eye-slash");
    }
  };

  // Example: When the toggle is changed
document.addEventListener("DOMContentLoaded", function() {
  const shareDataToggle = document.getElementById('shareDataToggle');
  if (shareDataToggle) {
    // On load, read localStorage to restore the toggle's previous state
    shareDataToggle.checked = (localStorage.getItem('shareDataEnabled') === 'true');

    // Whenever the toggle changes, update localStorage
    shareDataToggle.addEventListener('change', function() {
      localStorage.setItem('shareDataEnabled', shareDataToggle.checked);
      console.log("Data sharing is now", shareDataToggle.checked ? "ON" : "OFF");
    });
  }
});


    //draggable logic
    $(function(){
      // Draggable logic for header
      $("#settings-header").draggable({
        stop: function(event, ui) {
          localStorage.setItem("settingsHeaderPos", JSON.stringify(ui.position));
        }
      });
      const headerPos = localStorage.getItem("settingsHeaderPos");
      if(headerPos) {
        $("#settings-header").css(JSON.parse(headerPos));
      }

      // Draggable logic for each settings card
      $(".settings-card").each(function(){
        const id = $(this).attr("id");
        const savedPos = localStorage.getItem(id + "Pos");
        if(savedPos) {
          $(this).css(JSON.parse(savedPos));
        }
        // Cancel dragging on child button containers
        // $(this).draggable({
        //   cancel: "#save-button, #cancel-button, #notification-cancel, #privacyButton, #privacy-cancel, #privacy-save, #exportDataButton",
        //   stop: function(event, ui) {
        //     console.log(id, ui);
        //     localStorage.setItem(id + "Pos", JSON.stringify(ui.position));
        //   }
        // });
      });

      // Make Save & Cancel button containers draggable within #card-profile
      $("#save-button, #cancel-button").draggable({
        containment: "#card-profile"
      });
      // Make Notification Cancel button draggable within #card-notifications
      $("#notification-cancel").draggable({
        containment: "#card-notifications"
      });
    });

    //profile picture logic
    document.addEventListener('DOMContentLoaded', function() {
    const profilePicInput = document.getElementById('profilePic');
    const previewImg = document.getElementById('profilePicPreview');

    profilePicInput.addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          // e.target.result is the base64 string
          const base64String = e.target.result;

          // 1) Show a small preview in settings (optional)
          previewImg.src = base64String;
          previewImg.style.display = 'block';

          // 2) Store the base64 string in localStorage
          localStorage.setItem('profilePictureBase64', base64String);

          // If you also want to store it as "the user definitely wants it," you might do so on "Save" 
          // but for immediate demonstration, storing it here is fine.
        };
        reader.readAsDataURL(file);
      } else {
        // If user clears the file or cancels
        previewImg.style.display = 'none';
        localStorage.removeItem('profilePictureBase64'); 
      }
    });
  });

    //profile card js 
    async function expandProfileCard() {

      if (!auth.currentUser) {
    alert("No user is logged in. Please log in first.");
    return;
  }
  
  const userRef = ref(db, 'users/' + auth.currentUser.uid);
  const snapshot = await get(userRef);
  if (!snapshot.exists()) {
    console.log("No user data found in the database.");
    return;
  }
  
  const userData = snapshot.val();
  document.getElementById('profileName').value = userData.username || "";
      const profileBtn = document.getElementById("profileButton");
      const profileCard = document.getElementById("card-profile");
      const profileMenu = profileCard.querySelector(".profile-menu");

      // Fade out the Edit Profile button
      profileBtn.style.transition = "opacity 0.3s";
      profileBtn.style.opacity = 0;
      profileMenu.style.zIndex = '99';


      

      // Animate card's height from 120px to 300px
      const startHeight = 120;
      const endHeight = 300;
      const duration = 1000;
      const startTime = performance.now();

      function animateHeight(currentTime) {
        const elapsed = currentTime - startTime;
        const fraction = Math.min(elapsed / duration, 1);
        const currentHeight = startHeight + (endHeight - startHeight) * fraction;
        profileCard.style.height = currentHeight + "px";

        // Start the menu fade/slide earlier (fraction > 0.5)
        if (fraction > 0.5) {
          profileMenu.style.opacity = 1;
          profileMenu.style.transform = "translateY(0)";
        }

        if (fraction < 1) {
          requestAnimationFrame(animateHeight);
        }
      }
      requestAnimationFrame(animateHeight);
    }


    // save button logic for
    async function saveProfileChanges() {
  try {
    const newName = document.getElementById('profileName').value.trim();
    const fileInput = document.getElementById('profilePic');
    let base64Pic = "";
    if (fileInput.files && fileInput.files[0]) {
      base64Pic = await fileToBase64(fileInput.files[0]);
    }

    // Save the new profile data to Firebase (or your backend)
    await set(ref(db, 'users/' + auth.currentUser.uid), {
      username: newName,
      profileIcon: base64Pic
    });

    

    // Also store the picture in localStorage if needed
    if (base64Pic) {
      localStorage.setItem('profilePictureBase64', base64Pic);
    } else {
      localStorage.removeItem('profilePictureBase64');
    }

    // Update the profile picture container to use the uploaded image
    updateProfilePicture();

    // Optionally collapse the profile card or update other UI elements
    collapseProfileCard();

  } catch (err) {
    console.error(err);
    alert('Error saving profile changes.');
  }
  if (base64Pic) {
  localStorage.setItem('profilePictureBase64', base64Pic);
} else {
  localStorage.removeItem('profilePictureBase64');
}
await set(ref(db, 'users/' + auth.currentUser.uid), {
  username: newName,
  profileIcon: base64Pic
});


}


/**
 * Utility function: convert a File to Base64
 */
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result);
    reader.onerror = e => reject(e);
    reader.readAsDataURL(file);
  });
}


    function collapseProfileCard() {
      const profileBtn = document.getElementById("profileButton");
      const profileCard = document.getElementById("card-profile");
      const profileMenu = profileCard.querySelector(".profile-menu");

      // Fade out the profile menu and slide it down
      profileMenu.style.transition = "opacity 0.5s, transform 0.5s";
      profileMenu.style.opacity = 0;
      profileMenu.style.transform = "translateY(15px)";

      // Animate card's height from 300px back to 120px
      const startHeight = 300;
      const endHeight = 120;
      const duration = 1000;
      const startTime = performance.now();

      function animateCollapse(currentTime) {
        const elapsed = currentTime - startTime;
        const fraction = Math.min(elapsed / duration, 1);
        const currentHeight = startHeight - (startHeight - endHeight) * fraction;
        profileCard.style.height = currentHeight + "px";

        if (fraction < 1) {
          requestAnimationFrame(animateCollapse);
        } else {
          // Once collapse is complete, show the Edit Profile button again
          profileBtn.style.transition = "opacity 0.3s";
          profileBtn.style.opacity = 1;
        }
      }
      requestAnimationFrame(animateCollapse);
    }

    document.addEventListener("DOMContentLoaded", function() {
  const fileInput = document.getElementById('profilePic');
  const previewImg = document.getElementById('profilePicPreview');

  fileInput.addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const base64String = e.target.result;
        // 1) Show preview in settings
        previewImg.src = base64String;
        previewImg.style.display = 'block';

        // 2) Store Base64 string in localStorage (and/or send to backend)
        localStorage.setItem('profilePictureBase64', base64String);

        // Optionally, call a function to update your backend (e.g., Firebase)
        // updateProfilePictureInDB(base64String);
      };
      reader.readAsDataURL(file);
    } else {
      previewImg.style.display = 'none';
      localStorage.removeItem('profilePictureBase64');
    }
  });
});







//notification card js 
    function expandNotificationCard() {
      const notificationBtn = document.getElementById("notificationButton");
      const notificationCard = document.getElementById("card-notifications");
      const notificationMenu = notificationCard.querySelector(".notification-menu");

      // Fade out the Notification Preferences button
      notificationBtn.style.transition = "opacity 0.3s";
      notificationBtn.style.opacity = 0;

      // Animate card's height from 120px to 250px
      const startHeight = 120;
      const endHeight = 160;
      const duration = 500;
      const startTime = performance.now();

      function animateHeight(currentTime) {
        const elapsed = currentTime - startTime;
        const fraction = Math.min(elapsed / duration, 1);
        const currentHeight = startHeight + (endHeight - startHeight) * fraction;
        notificationCard.style.height = currentHeight + "px";

        // Start the menu fade/slide earlier (fraction > 0.5)
        if (fraction > 0.5) {
          notificationMenu.style.opacity = 1;
          notificationMenu.style.transform = "translateY(0)";
        }

        if (fraction < 1) {
          requestAnimationFrame(animateHeight);
        }
      }
      requestAnimationFrame(animateHeight);
    } 


    document.addEventListener('DOMContentLoaded', function() {
  const welcomeToggle = document.getElementById('welcomeToggle');
  if (welcomeToggle) {
    console.log("Welcome toggle found!");
    // Restore toggle state on load
    welcomeToggle.checked = (localStorage.getItem('welcomeNotificationsEnabled') === 'true');
    console.log("Welcome notifications are", welcomeToggle.checked ? "ON" : "OFF");

    // Save the state whenever the user flips the toggle
    welcomeToggle.addEventListener('change', function() {
      localStorage.setItem('welcomeNotificationsEnabled', welcomeToggle.checked);
      console.log("Welcome notifications are now", welcomeToggle.checked ? "ON" : "OFF");
    });
  }
});


    function collapseNotificationCard() {
      const notificationBtn = document.getElementById("notificationButton");
      const notificationCard = document.getElementById("card-notifications");
      const notificationMenu = notificationCard.querySelector(".notification-menu");

      // Fade out and slide down the notification menu
      notificationMenu.style.transition = "opacity 0.5s, transform 0.5s";
      notificationMenu.style.opacity = 0;
      notificationMenu.style.transform = "translateY(15px)";

      // Animate card's height from 250px back to 120px
      const startHeight = 160;
      const endHeight = 120;
      const duration = 1000;
      const startTime = performance.now();

      function animateCollapse(currentTime) {
        const elapsed = currentTime - startTime;
        const fraction = Math.min(elapsed / duration, 1);
        const currentHeight = startHeight - (startHeight - endHeight) * fraction;
        notificationCard.style.height = currentHeight + "px";

        if (fraction < 1) {
          requestAnimationFrame(animateCollapse);
        } else {
          // Once collapse is complete, show the Notification Preferences button again
          notificationBtn.style.transition = "opacity 0.3s";
          notificationBtn.style.opacity = 1;
        }
      }
      requestAnimationFrame(animateCollapse);
    }

//start
    
   /**
 * Sends a notification email to the user.
 *  - If no email has ever been sent, it sends a special "first email" welcome.
 *  - Otherwise, it checks the user's budgets/goals and sends a relevant message.
 */
async function sendMeaningfulNotificationEmail() {
  

// -------------------------------------
// Attach event listener to the Save button
// -------------------------------------
document.getElementById('notification-save').addEventListener('click', async function() {
  // If the toggle is checked, send the email
  const emailToggle = document.getElementById('emailToggle');
  if (emailToggle && emailToggle.checked) {
    await sendMeaningfulNotificationEmail();
  } else {
    console.log("Email notifications not enabled. Email will not be sent.");
  }
  // You can also save other notification settings here, if needed
});
} 



//privacy card js
    function expandPrivacyCard() {
  const privacyBtn = document.getElementById("privacyButton");
  const privacyCard = document.getElementById("card-privacy");
  const privacyMenu = privacyCard.querySelector(".privacy-menu");

  // Fade out the Privacy Controls button
  privacyBtn.style.transition = "opacity 0.3s";
  privacyBtn.style.opacity = 0;

  // Animate card's height from 120px to 250px
  const startHeight = 120;
  const endHeight = 220;
  const duration = 1000;
  const startTime = performance.now();

  function animateHeight(currentTime) {
    const elapsed = currentTime - startTime;
    const fraction = Math.min(elapsed / duration, 1);
    const currentHeight = startHeight + (endHeight - startHeight) * fraction;
    privacyCard.style.height = currentHeight + "px";

    // Reveal the menu after half the animation
    if (fraction > 0.5) {
      privacyMenu.style.pointerEvents = "auto";  // Enable pointer events
      privacyMenu.style.opacity = 1;
      privacyMenu.style.transform = "translateY(0)";
    }
    if (fraction < 1) {
      requestAnimationFrame(animateHeight);
    }
  }
  requestAnimationFrame(animateHeight);
}

//privacy mode
document.addEventListener('DOMContentLoaded', function() {
  const privacyToggle = document.getElementById('privacyModeToggle');

  // Load privacy mode state on settings page load
  privacyToggle.checked = JSON.parse(localStorage.getItem('privacyModeEnabled')) || false;

  // Update localStorage whenever the toggle changes
  privacyToggle.addEventListener('change', function() {
    localStorage.setItem('privacyModeEnabled', privacyToggle.checked);
  });
});

window.expandProfileCard = expandProfileCard;
window.collapseProfileCard = collapseProfileCard;
window.saveProfileChanges = saveProfileChanges;
window.expandNotificationCard = expandNotificationCard;
window.collapseNotificationCard = collapseNotificationCard;
window.expandPrivacyCard = expandPrivacyCard;
window.collapsePrivacyCard = collapsePrivacyCard;
window.expandSecurityCard = expandSecurityCard;
window.collapseSecurityCard = collapseSecurityCard;

function collapsePrivacyCard() {
  const privacyBtn = document.getElementById("privacyButton");
  const privacyCard = document.getElementById("card-privacy");
  const privacyMenu = privacyCard.querySelector(".privacy-menu");

  // Fade out and slide down the menu
  privacyMenu.style.transition = "opacity 0.5s, transform 0.5s";
  privacyMenu.style.opacity = 0;
  privacyMenu.style.transform = "translateY(15px)";

  // Animate card's height from 250px back to 120px
  const startHeight = 220;
  const endHeight = 120;
  const duration = 1000;
  const startTime = performance.now();

  function animateCollapse(currentTime) {
    const elapsed = currentTime - startTime;
    const fraction = Math.min(elapsed / duration, 1);
    const currentHeight = startHeight - (startHeight - endHeight) * fraction;
    privacyCard.style.height = currentHeight + "px";

    if (fraction < 1) {
      requestAnimationFrame(animateCollapse);
    } else {
      // Once collapse is complete, show the Privacy Controls button again
      privacyBtn.style.transition = "opacity 0.3s";
      privacyBtn.style.opacity = 1;
    }
  }
  requestAnimationFrame(animateCollapse);
}

















//security card js 
function expandSecurityCard() {
    const securityBtn = document.getElementById("securityButton");
    const securityCard = document.getElementById("card-security");
    const securityMenu = securityCard.querySelector(".security-menu");

    // Fade out the "Change Settings" button
    securityBtn.style.transition = "opacity 0.3s";
    securityBtn.style.opacity = 0;

    // Animate from 120px to 300px (or your desired final height)
    const startHeight = 120;
    const endHeight = 300;
    const duration = 1000; // 1 second
    const startTime = performance.now();

    function animateHeight(currentTime) {
      const elapsed = currentTime - startTime;
      const fraction = Math.min(elapsed / duration, 1);
      const currentHeight = startHeight + (endHeight - startHeight) * fraction;
      securityCard.style.height = currentHeight + "px";

      // Once fraction > 0.5, fade & slide menu in
      if (fraction > 0.5) {
        securityMenu.style.pointerEvents = "auto";
        securityMenu.style.opacity = 1;
        securityMenu.style.transform = "translateY(0)";
      }
      if (fraction < 1) {
        requestAnimationFrame(animateHeight);
      }
    }
    requestAnimationFrame(animateHeight);
  }

  document.getElementById('securitySaveButton')
  .addEventListener('click', saveSecuritySettings);

export async function setTwoFactorEnabled(userId, isEnabled) {
  await update(ref(db, 'users/' + userId + '/security'), {
    twoFactorEnabled: isEnabled
  });
  console.log(`2FA is now ${isEnabled ? 'enabled' : 'disabled'} for user ${userId}`);
}

function generateOTP(length = 6) {
  let otp = '';
  for (let i = 0; i < length; i++) {
    otp += Math.floor(Math.random() * 10).toString();
  }
  return otp;
}


export async function loginWithTwoFactor(email, password) {
  const auth = getAuth();

  // 1. Attempt normal sign-in.
  const userCred = await signInWithEmailAndPassword(auth, email, password);
  const user = userCred.user;
  const userId = user.uid;

  // 2. Check 2FA status.
  const securitySnap = await get(ref(db, 'users/' + userId + '/security'));
  const securityData = securitySnap.val();

  if (!securityData || !securityData.twoFactorEnabled) {
    // No 2FA – proceed normally.
    return { status: 'success', message: 'Logged in without 2FA' };
  }

  // 3. 2FA is enabled – generate OTP.
  const otp = generateOTP(6);
  const expiresAt = Date.now() + 15 * 60 * 1000; // Expires in 15 minutes.
  await set(ref(db, 'twoFactor/' + userId), { otp, expiresAt });

  // 4. Send OTP via email.
  await sendEmailOTP(user.email, otp);

  // Return status so the UI can prompt for OTP entry.
  return { status: '2fa-required', message: 'OTP sent to email', userId };
}


export async function verifyOTP(userId, enteredCode) {
  const otpRef = ref(db, 'twoFactor/' + userId);
  const snap = await get(otpRef);
  
  if (!snap.exists()) {
    return { success: false, error: 'No OTP found. It may have expired.' };
  }
  
  const { otp, expiresAt } = snap.val();
  if (Date.now() > expiresAt) {
    return { success: false, error: 'OTP expired.' };
  }
  if (otp !== enteredCode) {
    return { success: false, error: 'Incorrect OTP.' };
  }
  
  await remove(otpRef);
  return { success: true };
}


export async function sendEmailOTP(email, otp) {
  const templateParams = {
    to_email: email,
    subject: 'Your One-Time Passcode (OTP)',
    message: `Your OTP is: ${otp}. It expires in 15 minutes.`
  };

  try {
    const response = await emailjs.send(
      'service_c8vr5z9',      // Replace with your actual EmailJS service ID
      'template_v14754w',     // Replace with your actual EmailJS template ID
      templateParams
    );
    console.log('EmailJS response:', response);
  } catch (error) {
    console.error('Failed to send OTP via EmailJS:', error);
    throw new Error('Failed to send OTP email.');
  }
}


export async function initiatePasswordChange(userId, userEmail) {

  
  // Check if 2FA is enabled for this user.
  const securitySnap = await get(ref(db, 'users/' + userId + '/security'));
  const securityData = securitySnap.val();
  
  if (!securityData || !securityData.twoFactorEnabled) {
    return { status: 'no-2fa', message: '2FA not enabled, proceed with password change directly.' };
  }
  
  // Generate and store OTP.
  const otp = generateOTP(6);
  const expiresAt = Date.now() + 15 * 60 * 1000; // 15 minutes from now.
  await set(ref(db, 'twoFactor/' + userId), { otp, expiresAt });
  
  // Send the OTP email via EmailJS.
  await sendEmailOTP(userEmail, otp);
  
  return { status: '2fa-required', message: 'OTP sent to email for password change.' };
}
  // Example: Save security settings changes to Firebase
  


  //end
  async function handlePasswordChange() {
  const userId = auth.currentUser.uid; // Ensure the user is logged in.
  const userEmail = auth.currentUser.email;
  
  const result = await initiatePasswordChange(userId, userEmail);
  if (result.status === 'no-2fa') {
    // Directly update the password:
    await auth.currentUser.updatePassword(newPassword);
    alert('Password changed successfully.');
  } else if (result.status === '2fa-required') {
    // Show UI for the user to enter the OTP.
    // For example:
    const enteredOTP = prompt('Enter the OTP sent to your email:');
    const verifyResult = await verifyOTP(userId, enteredOTP);
    if (verifyResult.success) {
      await auth.currentUser.updatePassword(newPassword);
      alert('Password changed successfully.');
    } else {
      alert('Error: ' + verifyResult.error);
    }
  }
}

  async function saveSecuritySettings() {
  try {
    // 1) Gather input values from the security card
    const newPassword = document.getElementById('newPassword').value.trim();
    const recoveryEmail = document.getElementById('recoveryEmail').value.trim();
    const twoFactorEnabled = document.getElementById('twoFactorToggle').checked;
    console.log('things updated');
    // 2) (Optional) Validate inputs as needed before proceeding

    // 3) Update the security settings in Firebase Realtime Database
    // (Assumes you have already initialized Firebase and have auth and database available)
    const userId = auth.currentUser.uid; // from firebase/auth
    // Here we update the security-related node for the user
    await update(ref(db, 'users/' + userId + '/security'), {
      newPassword: newPassword,      // NOTE: For a real app, consider using Firebase Auth methods to update passwords.
      recoveryEmail: recoveryEmail,
      twoFactorEnabled: twoFactorEnabled
      // Add other security settings here as needed
    });

    alert('Security settings updated successfully!');
    collapseSecurityCard(); // Collapse the security card (UI feedback)

  } catch (err) {
    console.error('Error saving security settings:', err);
    alert('Error saving security settings: ' + err.message);
  }
}
window.saveSecuritySettings = function saveSecuritySettings() {
  // ...
};

  function collapseSecurityCard() {
    const securityBtn = document.getElementById("securityButton");
    const securityCard = document.getElementById("card-security");
    const securityMenu = securityCard.querySelector(".security-menu");

    // Fade & slide menu out
    securityMenu.style.pointerEvents = "none";
    securityMenu.style.transition = "opacity 0.5s, transform 0.5s";
    securityMenu.style.opacity = 0;
    securityMenu.style.transform = "translateY(15px)";

    // Animate from 300px back down to 120px
    const startHeight = 300;
    const endHeight = 120;
    const duration = 1000;
    const startTime = performance.now();

    function animateCollapse(currentTime) {
      const elapsed = currentTime - startTime;
      const fraction = Math.min(elapsed / duration, 1);
      const currentHeight = startHeight - (startHeight - endHeight) * fraction;
      securityCard.style.height = currentHeight + "px";

      if (fraction < 1) {
        requestAnimationFrame(animateCollapse);
      } else {
        // Once done, show the button again
        securityBtn.style.transition = "opacity 0.3s";
        securityBtn.style.opacity = 1;
      }
    }
    requestAnimationFrame(animateCollapse);
  }

  /* Optional placeholder functions for the security menu items */
  function openChangePassword() {
    alert("Change Password functionality coming soon!");
  }
  
  function openRecoverySettings() {
    alert("Recovery Email/Phone settings coming soon!");
  }
  function confirmDeleteAccount() {
    if (confirm("Are you sure you want to delete your account?")) {
      alert("Account deletion initiated.");
    }
  }


































//inactivity lock 
  (function () {
    let inactivityTimeout;
    // Reset timer only if the inactivity lock is enabled.
    function resetTimer() {
      clearTimeout(inactivityTimeout);
      const lockToggle = document.getElementById('inactivityLockToggle');
      // Only set the timer if the toggle exists and is checked
      if (lockToggle && lockToggle.checked) {
        inactivityTimeout = setTimeout(lockApp, 300000); // 300,000 ms = 5 minutes
      }
    }
    
    // Listen to common activity events
    window.onload = resetTimer;
    document.onmousemove = resetTimer;
    document.onkeydown = resetTimer;
    document.onscroll = resetTimer;
    document.ontouchstart = resetTimer;
    
    // When the toggle changes, start or clear the timer accordingly.
    const lockToggle = document.getElementById('inactivityLockToggle');
    if (lockToggle) {
      lockToggle.addEventListener('change', function() {
        if (this.checked) {
          resetTimer();
        } else {
          clearTimeout(inactivityTimeout);
        }
      });
    }
    
    function lockApp() {
      document.getElementById('lockModal').style.display = 'flex';
    }
    window.lockApp = lockApp;
  })();

  function unlock() {
    const pwd = document.getElementById('unlockPassword').value;
    if (pwd === "password") {
      document.getElementById('lockModal').style.display = 'none';
      document.getElementById('unlockPassword').value = "";
    } else {
      alert("Incorrect password");
    }
  }

  //Profile logic

window.app = app; // Expose if needed



function setProfilePicture(username) {
  if (!username) return; // If no username is provided, exit the function.
  
  // Get the HTML elements that display the profile initial and container.
  const initialEl = document.getElementById('profile-initial');
  const pictureEl = document.getElementById('profile-picture');
  
  // If either element doesn't exist in the DOM, exit to avoid errors.
  if (!initialEl || !pictureEl) return;

  // Get the first character of the username, convert it to uppercase.
  const initial = username.charAt(0).toUpperCase();
  
  // Set the text content of the element that shows the initial.
  initialEl.textContent = initial;

  // Generate a random color for the background.
  const randomColor = '#' + Math.floor(Math.random() * 16777215).toString(16);
  
  // Apply the random background color to the profile picture container.
  pictureEl.style.backgroundColor = randomColor;
}
function updateProfilePicture() {
  const profileContainer = document.getElementById("profile-picture");
  const base64Pic = localStorage.getItem("profilePictureBase64");
  
  if (base64Pic) {
    // Set the background image to cover the whole container
    profileContainer.style.backgroundImage = `url(${base64Pic})`;
    profileContainer.style.backgroundSize = "cover";
    profileContainer.style.backgroundPosition = "center";
    // Optionally, remove any inner text (like the initial)
    profileContainer.innerHTML = "";
  } else {
    // If no image, you might reset to default settings:
    profileContainer.style.backgroundImage = "";
    // Optionally, restore the initial or any fallback content here.
  }
}

/** Wrap everything that references the DOM in DOMContentLoaded **/
document.addEventListener("DOMContentLoaded", () => { 
  /************************************************
   * PROFILE PICTURE SETUP
   ***********************************************/
   
 

  /************************************************
   * MESSAGE MODAL FUNCTIONS
   ***********************************************/
 
  /************************************************
   * NOTIFICATIONS LOGIC
   ***********************************************/
  function getNotifications() {
    return JSON.parse(localStorage.getItem('notifications')) || [];
  }
  function saveNotifications(notifs) {
    localStorage.setItem('notifications', JSON.stringify(notifs));
  }
  function addNotification({ text, icon, type }) {
    const notifs = getNotifications();
    notifs.push({
      id: Date.now().toString(),
      text,
      icon,
      type,
      read: false
    });
    saveNotifications(notifs);
  }
  function markNotificationRead(notificationId) {
    const notifs = getNotifications();
    const index = notifs.findIndex(n => n.id === notificationId);
    if (index !== -1) {
      notifs[index].read = true;
      saveNotifications(notifs);
    }
    openNotificationsMenu();
  }

  async function checkBudgetsAndGoals() {
    try {
      if (!auth.currentUser) {
        console.warn("No authenticated user");
        return;
      }
      const userId = auth.currentUser.uid;
      const userRef = ref(db, `users/${userId}`);
      const snapshot = await get(userRef);
      if (!snapshot.exists()) {
        console.log("No data found for user:", userId);
        return;
      }
      const data = snapshot.val();
      // Check Budget usage
      if (data.budgets && data.budgets.daily) {
        const { used, limit } = data.budgets.daily;
        const usagePercent = (used / limit) * 100;
        if (usagePercent >= 80 && usagePercent < 100) {
          addNotification({
            text: "Careful with spending, you're over 80% of your daily budget!",
            icon: "💸",
            type: "budget"
          });
        } else if (usagePercent >= 100) {
          addNotification({
            text: "You've exceeded your daily budget!",
            icon: "⚠️",
            type: "budget"
          });
        }
      }
      // Check Goals
      if (data.goals) {
        Object.keys(data.goals).forEach(goalId => {
          const goal = data.goals[goalId];
          if (!goal.completed && goal.savedSoFar >= goal.targetAmount) {
            update(ref(db, `users/${userId}/goals/${goalId}`), { completed: true });
            addNotification({
              text: `Congratulations on achieving your goal: ${goal.name}!`,
              icon: "🎉",
              type: "goal"
            });
          }
        });
      }
    } catch (error) {
      console.error("Error checking budgets/goals:", error);
    }
  }

  async function handleBellClick() {
    const welcomeEnabled = (localStorage.getItem('welcomeNotificationsEnabled') === 'true');
    if (!welcomeEnabled) {
      alert("Enable welcome notifications from the settings tab!");
    } else {
      await checkBudgetsAndGoals();
      console.log("Bell icon clicked!");
      openNotificationsMenu();
    }
  }
  window.handleMessageClick = handleMessageClick;


  function openNotificationsMenu() {
    const notifications = getNotifications();
    let menuHtml = "";
    if (notifications.length === 0) {
      menuHtml = `<div style="padding:10px; text-align:center; color:#888;">No new notifications.</div>`;
    } else {
      menuHtml = "<ul style='list-style:none; padding:10px; margin:0;'>";
      notifications.forEach(notif => {
        const style = notif.read ? "notif-read" : "notif-unread";
        menuHtml += `<li class="${style}" style="padding:10px; border-bottom:1px solid #eee; cursor:pointer;"
            onclick="markNotificationRead('${notif.id}')">
            ${notif.icon ? notif.icon + " " : ""}${notif.text}
          </li>`;
      });
      menuHtml += "</ul>";
    }
    let notifMenu = document.getElementById("notificationsMenu");
    if (!notifMenu) {
      notifMenu = document.createElement('div');
      notifMenu.id = "notificationsMenu";
      notifMenu.style.position = "absolute";
      notifMenu.style.top = "60px";
      notifMenu.style.right = "130px";
      notifMenu.style.backgroundColor = "#fff";
      notifMenu.style.border = "1px solid #ccc";
      notifMenu.style.borderRadius = "6px";
      notifMenu.style.boxShadow = "0 4px 8px rgba(0,0,0,0.1)";
      notifMenu.style.padding = "10px";
      notifMenu.style.zIndex = 10000;
      document.body.appendChild(notifMenu);
    }
    notifMenu.innerHTML = menuHtml;
    notifMenu.style.display = 'block';

    document.addEventListener('click', function handler(e) {
      if (!notifMenu.contains(e.target) && e.target.id !== 'bell-icon' && !e.target.closest('#bell-icon')) {
        notifMenu.style.display = 'none';
        document.removeEventListener('click', handler);
      }
    });
  }

  // Expose needed functions to the window if your HTML calls them inline:
  window.handleBellClick = handleBellClick;
  window.handleMessageClick = handleMessageClick;
  window.markNotificationRead = markNotificationRead;
  window.checkBudgetsAndGoals = checkBudgetsAndGoals;
  window.setProfilePicture = setProfilePicture;
});





  </script>
  <script src="/features/privacyMode.js"></script>
</body>
</html>